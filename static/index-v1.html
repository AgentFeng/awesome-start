<!doctype html>
<html ng-app="app">
  <header>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.1/angular.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.0.2/angular-resource.min.js"></script>

    <script language="javascript" type="text/javascript">
      angular.module('app', ['ngResource']);
      function BackendController($scope,$resource){
      
        $scope.gaEvent = function($event){
          $scope.clicked = $event.target.name;
          //Call your own backend to log an event.
          $scope.log_event($scope.clicked);
        };
        
        $scope.backend_locations = [
          {url : 'code-comparison.appspot.com', urlName : 'remote backend' },       
          {url : 'localhost:8080', urlName : 'localhost' } ];

        $scope.apikey = "123";
        
        //Replace this url with your final URL from the SingPath API path. 
        //$scope.remote_url = "localhost:8080";
        $scope.remote_url = "code-comparison.appspot.com";
        $scope.model = "user";
        $scope.waiting = "Ready";
        $scope.item = {};
        $scope.item_data = {'name':'Chris','age':'32'};
        
        //resource calls are defined here

        $scope.Model = $resource('http://:remote_url/:apikey/:model_type/:id',
                                {},{
                                //'save'  : { method: 'POST',   params: {} },
                                'update': { method: 'PUT',    params: {} },
                                'get': {method: 'JSONP', isArray: false, params:{callback: 'JSON_CALLBACK'}}
                                }
                            );
        
        //***********************
        //PUT and POST experiement starts here. 
        $scope.new_update = function(id){
          $scope.UpdateResource = $resource('http://'+$scope.remote_url+'/'+$scope.apikey+'/'+$scope.model+'/'+id, 
                        {}, {'update': { method: 'PUT',    params: {} }});
          var item = new $scope.UpdateResource({data:$scope.item});
          $scope.waiting = "Loading";
          $scope.item = item.$update();
          //$scope.waiting = $scope.Model.update($scope.item);
        };
        
        //using save to casue a POST to resource url
        //POSTing to index.html rather than resource url
        $scope.new_add = function(){
          $scope.SaveResource = $resource('http://'+$scope.remote_url+'/'+$scope.apikey+'/'+$scope.model);
          $scope.waiting = "Loading";
          var item = new $scope.SaveResource({data:$scope.item});
          $scope.item = item.$save();
          $scope.list();
        };
        //******************************
        //End POST and PUT experiment 
        
        $scope.get_metadata = function(){
          data = {'remote_url':$scope.remote_url,
                  'model_type':"metadata",
                  'apikey':$scope.apikey
                 }
          $scope.waiting = "Updating";       
          $scope.Model.get(data,
                function(response) { 
                  $scope.metadata = response;
                  $scope.waiting = "Ready";
                });  
        };

        $scope.list = function(){
          data = {'remote_url':$scope.remote_url,
                  'model_type':$scope.model,
                  'apikey':$scope.apikey
                 }
          $scope.waiting = "Updating";       
          $scope.Model.get(data,
                function(response) { 
                  
                  $scope.items = response;
                  $scope.waiting = "Ready";
                });  
        };
                
        $scope.load = function(id){
          data = {'remote_url':$scope.remote_url,
                  'model_type':$scope.model,
                  'apikey':$scope.apikey, 
                  'id': id
                }
          $scope.waiting = "Loading";
          $scope.Model.get(data, 
              function(response){
                  
                  $scope.item = response;
                  $scope.item_data = $scope.item.data;
                  $scope.waiting = "Ready";  
              });        
        };
        
        $scope.update = function(id){
          data = {'remote_url':$scope.remote_url,
                  'model_type':$scope.model,
                  'apikey':$scope.apikey, 
                  'id': id,
                  'obj': JSON.stringify($scope.item_data) 
                }
          $scope.waiting = "Loading";
          $scope.Model.get(data, 
              function(response){
                  
                  $scope.item = response;
                  $scope.item_data = $scope.item.data;
                  $scope.list();
                  $scope.waiting = "Ready";  
              });        
        };
       
        $scope.add = function(){
          data = {'remote_url':$scope.remote_url,
                  'model_type':$scope.model,
                  'apikey':$scope.apikey, 
                  'obj': JSON.stringify($scope.item_data)
                }
          $scope.Model.get(data, 
              function(response){
                  $scope.item = response;
                  $scope.list();
              });
        };
        $scope.delete = function(id){
          data = {'remote_url':$scope.remote_url,
                  'model_type':$scope.model,
                  'apikey':$scope.apikey, 
                  'id': id
                }
          //Deletes are not async
          $scope.waiting = $scope.Model.remove(data);
          $scope.list();
        };
        //To add key/value pairs when creating new objects
        $scope.add_key_to_item = function(){
          $scope.item_data[$scope.newItemKey] = $scope.newItemValue;
        };
        
        $scope.log_event = function(message){
          data = {'remote_url':$scope.remote_url,
                  'model_type':"log",
                  'apikey':$scope.apikey, 
                  'obj': JSON.stringify({"message":message})
                }
          $scope.Model.get(data, 
              function(response){
                  $scope.last_log = response;
              });
        
        };
        
        $scope.list();         
      }
    </script>
    <!-- Bootstrap -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/static/css/bootstrap-responsive.css" rel="stylesheet">
  </header>
  <body ng-controller="BackendController" ng-click="gaEvent($event)">
  	<a href="https://github.com/SingaporeClouds/angularjs"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
    <div class="container">
    <h1>Backend-as-a-Service</h1>
    <p>Here is a project that you can fork on Github to start prototyping your own responsive design in a public gh-pages branch or any other publicly hosted folder like your Dropbox public folder. You can start by using the provided backend-as-a-service, and then later deploy your project to Google App Engine and use your own instance of the backend-as-a-service running in the free tier of Google App Engine.</p>
    <hr>
    <h3>Edit any items for a given api-key.</h3>
    Backend:     
    <select ng-model="remote_url" ng-options="item.url as item.urlName for item in backend_locations"></select><br>
    Base URL: {{remote_url}} <br>
    <hr>
      <form ng-submit="get_metadata()" class="form-inline">
        API Key: <input type="text" ng-model="apikey">
        <input type="submit" name="get metadata" value="get metadata">
      </form>
      Metadata: <pre>{{metadata}}</pre>
    <hr>
    <form ng-submit="list()" class="form-inline">
      Model: <input type="text" ng-model="model" placeholder="user">
      <input type="submit" name="list" value="list">
    </form> 

    There are {{items.entities.length}} items for {{model}}. Status: {{waiting}}
    <table class="table table-hover table-condensed">
      <th ng-repeat="(key,val) in items.entities[0]">
          {{key}}
      <th>
      <th>Delete</th>
    
      <tr ng-repeat="item in items.entities">
    
        <td ng-repeat="(key,val) in item">
          {{val}}
        </td>
        <td>
          <form ng-submit="load(item['id'])" style="margin-bottom: 0">
            <input type="submit" name="load" value="Load">
          </form>
        </td>
        <td>
          <form ng-submit="delete(item['id'])" style="margin-bottom: 0">
            <input type="submit" name="delete" value="Delete">
          </form>
        </td>
      </tr>
    </table>
      
 <hr>
    Item Data:
      <table>
          <tr>
            <td>ID:</td>
            <td><input type="text" ng-model="item.id"></td>
          </tr>
        <tr ng-repeat="(key,val) in item_data">
          <td>{{key}}:</td> <td> <input type="text" ng-model="item_data[key]"></td>
        </tr>
          <td><input type="text" ng-model="newItemKey" placeholder="add key here"></td>
          <td><input type="text" ng-model="newItemValue" placeholder="add value here"></td>
          <td>
            <form ng-submit="add_key_to_item()" class="form-inline">
              <input type="submit" value="Add key/value pair."> 
            </form>
          </td>

      </table>

    <form ng-submit="add()">
      <input type="submit" name="add new item" value="add new item (with GET)">
    </form>
    <form ng-submit="update(item.id)">
      <input type="submit" value="update item {{item.id}} (with GET)">
    </form>
    <!--
    <form ng-submit="new_add()">
      **<input type="submit" name="new add new item" value="add new item with save (POST)">**
    </form>
    <form ng-submit="new_update(item.id)">
      **<input type="submit" name="new update item" value="update item {{item.id}} with update (PUT)">**
    </form>
    <hr>-->

    <hr>
    Last clicked: {{this.clicked}}<br>
    <a href="" name="my link">Test link</a>
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    </div>
  </body>
</html>